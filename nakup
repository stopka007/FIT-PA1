#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>

int main (void) {
    char cely_seznam[100][10000];
    char jednotlivy_string[10000];
    char nakupni_list[100][10000];
    char regaly[100][10000];
    char duplikat[100][10000];
    char nedostupne[100][10000];
    int n = 0;
    int i = 0;
    int zacatecni_index = 0;
    int pocet_v_regalech = 0;
    int cislo_regalu = 0;
    int pocet_slozek_nakupu = 0;
    int index_pro_nakupni_list = 0;
    int podminka_pro_regal = '0';
    int pocet_regalu = 0;
    int podminka_pro_new_line = 0;
    int cislo_iterace = 0;
    char *line = NULL;
    size_t len;
    
    while (getline(&line, &len, stdin) != EOF) {
        if (*line != '\n'){
            line[strcspn(line, "\n")] = 0;
        }
        else {
            podminka_pro_new_line += 1;
        }
        strcpy(jednotlivy_string, line);
        strcpy(cely_seznam[n], jednotlivy_string);
        if (strcmp(cely_seznam[0], "#0") != 0) {
            printf("Nespravny vstup.\n");
            return 0;
        }
        while (jednotlivy_string[i] != '\0') {
            if (jednotlivy_string[i] == '#' && jednotlivy_string[i+1] == podminka_pro_regal){ 
                podminka_pro_regal += 1;
                pocet_regalu += 1;
            }
            else if (jednotlivy_string[i] == '#' && jednotlivy_string[i+1] != podminka_pro_regal){ 
                printf("Nespravny vstup.\n");
                return 0;
            }
            i += 1;
        }
        n+=1;
        i=0;
    }
    if (podminka_pro_new_line == 0) {
        printf("Nespravny vstup.\n");
        return 0;
    }
    for (int i=0; i<n; i++){
        if (*cely_seznam[i] != '\n'){
            strcpy(regaly[i], cely_seznam[i]);
            pocet_v_regalech += 1;
        }
        else {
            break;
        }
    }
    for (int k = pocet_v_regalech+1; k<n; k++){
        if (strcmp(nakupni_list[i], "\n") != 0){
            strcpy(nakupni_list[index_pro_nakupni_list], cely_seznam[k]);
            index_pro_nakupni_list += 1;
            pocet_slozek_nakupu +=1;
        }
        else {
            strcpy(nakupni_list[index_pro_nakupni_list], cely_seznam[k]);
            pocet_slozek_nakupu += 1;
            continue;
        }
    }
    int while_pocet_regalu = pocet_regalu;
    int vytisk = 0;
    int l = 0;
    int pocet_chybejicich = 0;
    printf("Optimalizovany seznam:\n");
    while ((podminka_pro_new_line) != 0){
        while_pocet_regalu = pocet_regalu + 1;
        cislo_iterace = 0;
        l = 0;
        while ( while_pocet_regalu != 0){
            for (int i = zacatecni_index; i <= pocet_slozek_nakupu; i++){
                    cislo_regalu = 0;
                    pocet_chybejicich = 0;
                if (strcmp(nakupni_list[i], "\n") == 0 && cislo_iterace != pocet_regalu){
                    cislo_iterace += 1;
                    while_pocet_regalu -= 1;
                    break;
                } 
                else if (strcmp(nakupni_list[i], "\n") == 0 && cislo_iterace == pocet_regalu){
                    podminka_pro_new_line -= 1;
                    zacatecni_index = i+1;
                    while_pocet_regalu -= 1;
                    for (int polozka = 0; polozka < l; polozka++){
                        printf("%d. %s -> N/A\n", vytisk, nedostupne[0]);
                        vytisk += 1;
                    }
                    vytisk = 0;
                    printf("Optimalizovany seznam:\n");
                    break;
                } 
                else if (strcmp(nakupni_list[i], "\0") == 0 && cislo_iterace != pocet_regalu){
                    cislo_iterace += 1;
                    break;
                } 
                else if (strcmp(nakupni_list[i], "\0") == 0 && cislo_iterace == pocet_regalu){
                    for (int polozka = 0; polozka < l; polozka++){
                        printf("%d. %s -> N/A\n", vytisk, nedostupne[0]);
                        vytisk += 1;
                    }
                    return 0;
                }
                else {
                    for (int k = 1; k < pocet_v_regalech; k++){
                        if (strncmp(regaly[k], "#", 1) == 0) {
                            cislo_regalu += 1;
                            continue;
                        }
                        else if (strcasecmp(nakupni_list[i], regaly[k]) == 0 && cislo_iterace == 0){
                            strcpy(duplikat[i], nakupni_list[i]);
                        }
                        else if (strcasestr(regaly[k], nakupni_list[i]) == NULL && cislo_iterace == 0){
                            pocet_chybejicich += 1;
                            if (pocet_chybejicich == (pocet_v_regalech - pocet_regalu)){
                                strcpy(nedostupne[l], nakupni_list[i]);
                                l += 1;
                            }
                        }
                        else if (strcasecmp(nakupni_list[i], regaly[k]) == 0 && cislo_regalu == (cislo_iterace - 1)) {
                            printf("%d. %s -> #%d %s\n", vytisk, nakupni_list[i], cislo_regalu, regaly[k]);
                            vytisk += 1;
                        }
                        else if (strcasestr(regaly[k], duplikat[i]) != NULL && *duplikat[i] != '\0'){
                            continue;
                        }
                        else if (strcasestr(regaly[k],nakupni_list[i]) && cislo_regalu == (cislo_iterace - 1)){
                            printf("%d. %s -> #%d %s\n", vytisk, nakupni_list[i], cislo_regalu, regaly[k]);
                            vytisk += 1;
                            *nakupni_list[i] = '1';
                        } 
                    }
                }
            }
        }
        podminka_pro_new_line -=1;
    }
    return 0;
}
